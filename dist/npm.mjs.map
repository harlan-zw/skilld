{"version":3,"file":"npm.mjs","names":[],"sources":["../src/npm.ts"],"sourcesContent":["/**\n * NPM package discovery and documentation resolution\n */\n\nexport interface NpmPackageInfo {\n  name: string\n  version?: string\n  description?: string\n  homepage?: string\n  repository?: {\n    type: string\n    url: string\n    directory?: string\n  }\n  readme?: string\n}\n\nexport interface ResolvedPackage {\n  name: string\n  version?: string\n  description?: string\n  docsUrl?: string\n  llmsUrl?: string\n  readmeUrl?: string\n  repoUrl?: string\n}\n\n/**\n * Fetch package info from npm registry\n */\nexport async function fetchNpmPackage(packageName: string): Promise<NpmPackageInfo | null> {\n  const res = await fetch(`https://registry.npmjs.org/${packageName}/latest`, {\n    headers: { 'User-Agent': 'skilld/1.0' },\n  }).catch(() => null)\n\n  if (!res?.ok) return null\n  return res.json()\n}\n\n/**\n * Resolve documentation URL for a package\n */\nexport async function resolvePackageDocs(packageName: string): Promise<ResolvedPackage | null> {\n  const pkg = await fetchNpmPackage(packageName)\n  if (!pkg) return null\n\n  const result: ResolvedPackage = {\n    name: pkg.name,\n    version: pkg.version,\n    description: pkg.description,\n  }\n\n  // Extract repo URL\n  if (pkg.repository?.url) {\n    const repoUrl = pkg.repository.url\n      .replace(/^git\\+/, '')\n      .replace(/\\.git$/, '')\n      .replace(/^git:\\/\\//, 'https://')\n      .replace(/^ssh:\\/\\/git@github\\.com/, 'https://github.com')\n    result.repoUrl = repoUrl\n  }\n\n  // Try homepage for docs (skip if it's just a GitHub repo URL)\n  if (pkg.homepage && !isGitHubRepoUrl(pkg.homepage)) {\n    result.docsUrl = pkg.homepage\n  }\n\n  // GitHub repo handling\n  if (result.repoUrl?.includes('github.com')) {\n    const match = result.repoUrl.match(/github\\.com\\/([^/]+)\\/([^/]+)/)\n    if (match) {\n      const owner = match[1]\n      const repo = match[2]\n      const subdir = pkg.repository?.directory\n\n      // If no docsUrl, try to get website from GitHub repo metadata\n      if (!result.docsUrl) {\n        const repoMeta = await fetchGitHubRepoMeta(owner, repo)\n        if (repoMeta?.homepage) {\n          result.docsUrl = repoMeta.homepage\n        }\n      }\n\n      // README fallback via ungh\n      const unghUrl = subdir\n        ? `https://ungh.cc/repos/${owner}/${repo}/files/main/${subdir}/README.md`\n        : `https://ungh.cc/repos/${owner}/${repo}/readme`\n\n      const unghRes = await fetch(unghUrl, {\n        headers: { 'User-Agent': 'skilld/1.0' },\n      }).catch(() => null)\n\n      if (unghRes?.ok) {\n        result.readmeUrl = `ungh://${owner}/${repo}${subdir ? `/${subdir}` : ''}`\n      }\n      else {\n        // Fallback to raw.githubusercontent.com\n        const basePath = subdir ? `${subdir}/` : ''\n        for (const branch of ['main', 'master']) {\n          const readmeUrl = `https://raw.githubusercontent.com/${owner}/${repo}/${branch}/${basePath}README.md`\n          if (await verifyUrl(readmeUrl)) {\n            result.readmeUrl = readmeUrl\n            break\n          }\n        }\n      }\n    }\n  }\n\n  // Check for llms.txt on docsUrl\n  if (result.docsUrl) {\n    const llmsUrl = `${result.docsUrl.replace(/\\/$/, '')}/llms.txt`\n    if (await verifyUrl(llmsUrl)) {\n      result.llmsUrl = llmsUrl\n    }\n  }\n\n  // Must have at least one source\n  if (!result.docsUrl && !result.llmsUrl && !result.readmeUrl) {\n    return null\n  }\n\n  return result\n}\n\nexport interface LocalDependency {\n  name: string\n  version: string\n}\n\n/**\n * Read package.json dependencies with versions\n */\nexport async function readLocalDependencies(cwd: string): Promise<LocalDependency[]> {\n  const { readFileSync, existsSync } = await import('node:fs')\n  const { join } = await import('node:path')\n\n  const pkgPath = join(cwd, 'package.json')\n  if (!existsSync(pkgPath)) {\n    throw new Error('No package.json found in current directory')\n  }\n\n  const pkg = JSON.parse(readFileSync(pkgPath, 'utf-8'))\n  const deps: Record<string, string> = {\n    ...pkg.dependencies,\n    ...pkg.devDependencies,\n  }\n\n  return Object.entries(deps)\n    .filter(([name]) =>\n      // Skip common non-doc packages\n      !name.startsWith('@types/')\n      && !['typescript', 'eslint', 'prettier', 'vitest', 'jest'].includes(name),\n    )\n    .map(([name, version]) => ({\n      name,\n      // Clean version string (remove ^, ~, etc.)\n      version: version.replace(/^[\\^~>=<]/, ''),\n    }))\n}\n\n/**\n * Get installed skill version from SKILL.md\n */\nexport async function getInstalledSkillVersion(\n  skillDir: string,\n): Promise<string | null> {\n  const { readFileSync, existsSync } = await import('node:fs')\n  const { join } = await import('node:path')\n\n  const skillPath = join(skillDir, 'SKILL.md')\n  if (!existsSync(skillPath)) return null\n\n  const content = readFileSync(skillPath, 'utf-8')\n  const match = content.match(/^version:\\s*\"?([^\"\\n]+)\"?/m)\n  return match?.[1] || null\n}\n\n/**\n * Fetch GitHub repo metadata to get website URL\n */\nasync function fetchGitHubRepoMeta(owner: string, repo: string): Promise<{ homepage?: string } | null> {\n  const res = await fetch(`https://api.github.com/repos/${owner}/${repo}`, {\n    headers: { 'User-Agent': 'skilld/1.0' },\n  }).catch(() => null)\n\n  if (!res?.ok) return null\n  const data = await res.json().catch(() => null)\n  return data?.homepage ? { homepage: data.homepage } : null\n}\n\n/**\n * Check if URL is on github.com (not a docs site, we'll fetch the repo's website instead)\n */\nfunction isGitHubRepoUrl(url: string): boolean {\n  try {\n    const parsed = new URL(url)\n    return parsed.hostname === 'github.com' || parsed.hostname === 'www.github.com'\n  }\n  catch {\n    return false\n  }\n}\n\nasync function verifyUrl(url: string): Promise<boolean> {\n  const res = await fetch(url, {\n    method: 'HEAD',\n    headers: { 'User-Agent': 'skilld/1.0' },\n  }).catch(() => null)\n\n  if (!res?.ok) return false\n\n  const contentType = res.headers.get('content-type') || ''\n  // Reject HTML (likely 404 page)\n  return !contentType.includes('text/html')\n}\n"],"mappings":"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"}